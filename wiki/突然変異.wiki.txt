
v21kuで追加された魔法植物のシステム。

種子の追加ドロップが生じた際に、確率で地形生成時と同じテーブルで特性ビットが変異する。

* 性質 [#i74f6c47]

種子が複数個同時にドロップする際は、スタック単位ではなく1個ごとに個別に判定される。

----

特性ビットが追加されることもあれば、欠損することもある。
- これにより初期所持特性を削除することもできる。
- 現在全く所持していない特性のビットが新規に付くこともある。

----

その植物で突然変異可能な特性（ランダム特性）しか変異せず、全く無関係の特性がいきなり付いたりはしない。
- 交雑で持ち込んだ本来その植物に付かない特性が消えることもない。
- 魔法植物種ごとのランダム特性テーブルは魔法植物データを参照。

----

特性が既に15個付いている場合、所持していない特性は抽選リストから外れる。
- 特性を15個埋めた状態で突然変異を狙うことで、突然変異の確率をある程度操作できる。
- 特性ごとに抽選確率が決まっているが、それが''あふれた場合はビットの桁数に還元されるため、抽選リストを厳選する意味はあまりない''。

----

v21.3kuから最大15桁のビットまで付くようになった。
- それ以前は最大10桁であった。

* アルゴリズム [#wdf4f58d]

これはv21.8kuの更新履歴からの突然変異アルゴリズムの引用である。
- 追加種子ドロップの生の個数rを計算する。
- 追加種子ドロップの上限nを3個（種子希釈で拡張可能）とする。
- 追加種子ドロップが溢れた場合、その割合f=r/nを覚えておく。
- 追加種子ドロップ1個1個について、突然変異特性効果の割合で判定する。
-- 突然変異が発生しなかった場合、突然変異のない通常種子が落ちる。
- 突然変異が発生した場合、ランダム特性テーブルによって特性を抽選する。
-- このとき、抽選確率にfを乗じる。
-- 抽選確率が100%を超えた場合、特性ビットの抽選確率に乗じられる。

----

ビットの抽選率があふれた場合、低レアのビットの出現率が削られる形で帳尻を合わせられる。

** 例 [#r9ef17f4]

もともとr=8個ドロップする予定だった場合、
種子希釈100%でドロップ数の上限はn=4となる。
このとき、特性の抽選率にかかる割合はf=r/n=8/4=2。

----

突然変異可能な特性を15種類持っている場合、
1種類当たりの抽選確率が5%とすると、
通常合計75%の確率で変異が発生する。

----

fは各特性の抽選確率に乗じられるので、
各特性の抽選確率はそれぞれ5%×2=10%となり、
15種類合計の抽選確率は150%となる。

この確率は100%を超えているので、各特性の比率は変えずに100%に圧縮される。
この圧縮で失われた「1.5倍」の倍率は、あとで特性ビットの抽選確率に乗じられる。

----

突然変異特性効果が40%だった場合、
60%の確率で突然変異特性効果不発による通常種子が得られ、
40%の確率で突然変異特性の抽選に入る。

----

突然変異特性の抽選は上述の強化された抽選テーブルを使うため、100%の確率でいずれかの特性が選ばれる。

----

次は特性ビットの抽選に入る。
桁が1個大きくなるごとに、出る確率は1/√10倍になる。
- つまり、「2個左の桁は10倍レア」である。
上で失われた「1.5倍」は、ここで各特性ビットの抽選確率に乗じられる。
- 例えば通常1%の確率で出現する桁のビットであれば、1.5%の確率で出るようになる。
- 結果、ある段階よりレアなビットは確率がその割合乗じられ、低レアなビットは出現確率が均等になる。
